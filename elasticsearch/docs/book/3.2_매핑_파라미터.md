## 3.2 매핑 파라미터

- 색인할 필드의 데이터를 어떻게 저장할지에 대한 다양한 옵션을 제공
### `analyzer`
- 해당 필드의 데이터를 형태소 분석하겠다는 의미의 파라미터
- 색인과 검색 시 지정한 분석기로 형태소 분석을 수행
- text 데이터 타입의 필드는 analyzer 매핑 파라미터를 기본적으로 사용
- 별도로 분석기를 지정하지 않으면 Standard Analyzer 로 형태소 분석을 수행

### `normalizer`
- `term query`에 `분석기를 사용`하기 위해서 사용
```text
ex) keyword 데이터 타입의 경우 원문을 기준으로 문서가 색인되기 때문에 cafe, Cafe, Café는 서로 다른문서로 인식된다.
하지만 해당 유형을 normalizer를 통해 분석기에 asciifolding과 같은 필터를 사용하면 같은 데이터로 인식되게 할 수 있다.
```

### `boost`
- 필드에 가중치를 부여한다.
- 가중치에 따른 유사도 점수(_score)가 달라지기 때문에 boost 설정 시 검색 결과의 노출 순서에 영향을 준다.
- 만약 색인 시점에 boost 설정을 하게 된다면, 재색인하지 않는 이상 가중치 변경을 할 수 없기 떄문에 주의해서 사용 필요
- 가급적이면 `검색 시점에만 사용`하는 것을 권장한다.
> 최근 엘라스틱서치는 색인 시 boost 설정을 할 수 없도록 바뀌었다. [참고](https://stackoverflow.com/questions/45822066/index-time-field-level-boosting-in-lucene-6-6-0)

### `coerce`
- 색인 시 자동 변호나을 허용할 지 여부를 설정하는 파라미터
- 숫자 형태의 문자열이 integer 타입의 필드에 들어온다면 엘라스틱서치는 자동으로 형변환을 수행해서 정상적으로 처리
- coerce 설정을 미사용으로 변경하는 경우 색인에 실패

### `copy_to`
- 매핑 파라미터를 추가한 필드의 값을 지정한 필드로 복사
- keyword 타입의 필드에 copy_to 매핑 파라미터를 사용해 다른 필드로 값을 복사하면
  복사된 필드에서는 text 타입을 지정해 형태소 분석이 가능
- 여러 개의 필드 데이터를 하나의 필드에 모아서 전체 검색 용도로 사용하여 `_all` 컬럼과 동일한 기능을 제공 가능

### `fielddata`
- 엘라스틱 서치가 `힙 공간에 생성하는 메모리 캐시`
- 반복적인 메모리 부족 현상과 잦은 GC로 현재는 거의 사용하지 않음
- 최신 버전의 엘라스틱서치는 `doc_values` 라는 새로운 형태의 캐시를 제공
- `text 타입의 필드를 제외`한 `모든 필드는 기본적`으로 `doc_values 캐시`를 사용
- `fielddata`는 메모리 소모가 크기 때문에 기본적으로 **비활성화**되어 있다.
- 그럼에도 `fielddata`를 사용해야 하는 경우
    - `text` 타입의 필드에서 집계나 정렬을 수행하는 경우 <br>
      (`text` 타입의 필드는 기본적으로 분석기에 의해 형태소 분석이 되기 떄문에 집계나 정렬 등의 기능을 수행할 수 없다.)
- 사용방법
    ```shell
    PUT {index명}/_mapping/_doc
    {
      "properties" : {
        "{필드명}" : {
          "type" : "text",
          "fielddata" : true
        }
      }
    }
    ```
### `doc_values`
- 엘라스틱서치에서 사용하는 기본 캐시
- `text 타입을 제외`한 `모든 타입`에서 기본적으로 `doc_values 캐시`를 사용
- 과거에는 캐시를 모두 메모리에 올려서 사용하였으나 현재는 `doc_values`를 사용함으로써 힙 사용에 대한 부담을 없애고,
  운영체제의 파일시스템 캐시를 통해 디스크에 있는 데이터에 빠르게 접근할 수 있다.
- **GC의 비용이 들지 않으면서 메모리 연산과 비슷한 성능을 보여준다.**
- 필드를 정렬, 집계할 필요가 없고 스크립트에서 필드 값에 액세스할 필요가 없다면 디스크 공간을 절약하기 위해 `doc_values`를 비활성화 가능
- 한 번 비활성화된 필드는 인덱스를 재색인 하지 않는 한 변경 불가

### `dynamic`
- 매핑에 필드를 추가할 때 동적으로 생성할 지, 생성하지 않을지를 결정
- 동적 생성 필드의 처리 방벙 세 가지

|인자|설명|
|:---|:---|
|true|새로 추가되는 필드를 매핑에 추가|
|false|새로 추가되는 필드를 무시,<br> 해당 필드는 색인되지 않아 검색할 수 없지만, `_source`(메타필드)에는 표시|
|strict|새로운 필드가 감지되면 예외가 발생하고 문서 자체가 색인되지 않는다. <br/> 새로 유입되는 필드는 사용자가 매핑에 명시적으로 추가해야 한다.|

### `enabled`
- 검색 결과에는 포함하지만, 색인은 하고 싶지 않은 경우에 대한 설정 (`메타 성격의 데이터`)
    ```text
    ex) 일반적인 게시판의 경우 제목과 요약 글만 색인, 날짜와 사용자 ID는 색인하지 않는 경우
    ```
- 사용방법
    - enabled를 false로 설정 시 _source에는 검색이 되지만 색인은 하지 않는다.
### `format`
- 날짜/시간을 문자열로 표시, 해당 데이터 타입으로 변경 시 미리 구성된 포맷을 사용할 수 있다.
- 날짜/시간 데이터 타입의 날짜 형식

|포맷|날짜 형식|비고|
|:---|:---|:---|
|basic_date|yyyyMMdd|년도/월/일|
|basic_date_time|yyyyMMdd'T'HHmmss.SSSZ|년도/월/일|
|basic_time|HHmmss.SSSZ|시/분/초/밀리초/Z|
|date/<br/>strict_date|yyyy-MM-dd|년도/시/분|
|date_hour_minute_second/<br/>strict_date_hour_minute_second|yyyy-MM-dd'T'HH:mm:ss.|년도/시/분/T/시/분/초|
|date_hour_minute_second_millis/<br/>strict_date_hour_minute_second_millis|yyyy-MM-dd'T'HH:mm:ss.SSS|년도/시/분/T/시/분/초/밀리초|
|date_time/<br/>strict_date_time|yyyy-MM-dd'T'HH:mm:ss.SSSZZ|년도/시/분/T/시/분/초/밀리초/ZZ|

### `ignore_above`
- 필드에 저장되는 문자열이 지정한 크기를 넘어서면 빈 값으로 색인
- 지정한 크기만큼만 색인 되는 것이 아니라 빈 값으로 저장되므로 주의

### `ignore_malformed`
- 잘못된 데이터 타입을 색인하려고 하면 예외가 발생하고 해당 문서 전체가 색인되지 않는다.
- 매핑 파라미터 사용시, 해당 필드만 무시하고 문서는 색인할 수 있다.

### `index`
- 필드 값을 색인 여부를 결정
- 기본 값은 true, false로 변경하면 해당 필드를 색인하지 않는다.

### `fields`
- 다중 필드(multi_field)를 설정할 수 있는 옵션
- 필드 안에 또 다른 필드의 정보를 추가할 수 있어 같은 string 값을 각각 다른 분석기로 처리하도록 설정할 수 있다.
    ```text
    ex) 기본 필드는 전문검색, 필드 안의 추가 필드는 집계용으로 사용 가능
    ```
    - 요청 API
    ```shell
    PUT {index명}
    {
      "mappings": {
        "_doc" : {
          "properties" : {
            // 전문검색
            "{필드명}": {
              "type" : "text",
              "fields": {
                // 집계용 필드
                "{추가필드명}" : {
                  "type" : "keyword"
                }
              }
            }
          }
        }
      }
    }
    ```

### `norms`
- 문서의 `_score` 값 계산에 필요한 정규화 인수를 사용할지 여부를 설정
- 기본 값은 true, `_score` 계산이 필요없거나 단순 필터링 용도로 사용하는 필드는 비활성화해서 디스크 공간을 절약할 수 있다.

### `null_value`
- 색인 시 문서에 필드가 없거나 필드의 값이 `null`이면 색인 시 필드를 생성하지 않는다.
- `null_value`를 설정할 경우 문서의 값이 `null` 이더라도 필드를 생성하고 그에 해당하는 값으로 저장한다.
- 요청 API
    ```shell
    PUT {index명}/_mapping/_doc
    {
      "properties": {
        "{필드명}": {
          "type": "integer",
          "null_value": "0"
        }
      }
    }
    ```

### `position_increment_gap`
- 배열 혈태의 데이터를 색인할 떄 검색의 정확도를 높이기 위해 제공하는 옵션
- 필드 데이터 중 단어와 단어 사이의 간격을 허용할 지 여부를 설정
- 검색 시 단어와 단어 사이의 간격을 기준으로 일치하는 문서를 찾는데 필요
```text
{"Jone Abraham", "Lincon Smith"}
"Abraham Lincon"으로 검색 시 검색이 가능
```

### `properties`
- 오브젝트(object) 타입이나 중첩(nested) 타입의 스키마를 정의할 때 사용되는 옵션
- 필드의 타입을 매핑
- 오브젝트 필드 및 중첩 필드에는 `properties`라는 서브 필드가 있다.
- `properties` 는 `object`나 `nested`를 포함한 모든 데이터 타입이 될 수 있다.

### `search_analyzer`
- 일반적으로 색인과 검색 시 같은 분석기를 사용
- 만약 다른 분석기를 사용하고 싶은 경우 `search_analyzer`를 설정해서 검색 시 사용할 분석기를 `별도로 지정`할 수 있다.

### `similarity`
- 유사도 측정 알고리즘을 지정
- 유사도 측정 방식을 기본 알고리즘인 BM25에서 다른 알고리즘으로 변경할 수 있다.

|알고리즘|설명|
|:---|:---|
|BM25|Okapi BM25 알고리즘으로 엘라스틱서 치의 기본 유사도 측정 알고리즘|
|classic|TF/IDF 알고리즘으로 문서 내 용어의 개수와 전체 용어의 개수를 이용해 유사도를 계산|
|boolean|복잡한 수학적 모델을 사용하지 않고 단순히 boolean  연산으로 유사도를 측정 <br> score는 검색어 일치 여부에 따라 결정, 검색 결과의 일치 여부에 따라 쿼리의 가중치에 사용된 점수로만 유사도를 계산|

### `store`
- 필드 값을 저장하여 검색 결과에 값을 포함하기 위한 매핑 파라미터
- 기본적으로 엘라스틱서치에서는 _source에 색인된 문서가 저장되는데, store 매핑 파라미터를 사용하면 해당 필드를 자체적으로 저장할 수 있다.
- 10개의 필드가 존재하고 해당 필드에 데이터를 매핑한 상태인 경우 `_source를 로드해서 해당 필드를 찾는 것 보다` **사용할 각 필드로만 로드해서 사용하는 편이 효율적**
- `store` 파라미터는 디스크를 더 많이 사용

### `term_vector`
- 분석된 용어의 정보를 포함할지 여부를 결정

|인자|설명|
|:---|:---|
|`no`|`term_bector`를 저장하지 않는다.|
|`yes`|필드와 용어만 저장한다.|
|`with_positions`|용어, 용어의 시작과 끝 위치를 저장|
|`with_offsets`|용어, 문자 오프셋을 저장|
|`with_positions_offsets`|용어, 용어의 시작과 끝 위치, 문자 오프셋을 모두 저장|
