## 2.1 엘라스틱 서치를 구성하는 개념
분산 시스템을 지향하는 엘라스틱 서치의 전체적인 아키텍처에 대한 이해

### 기본 용어
- 인덱스, 타입 문서, 필드로 구성

> @인덱스
- 데이터 저장 공간
- 하나의 인덱스는 하나의 타입을 가지며, 하나의 물리적인 노드에 여러 개의 논리적인 인덱스를 생성할 수 있다.
- 검색 시 인덱스 이름으로 문서를 검색, 여러 인덱스를 동시에 검색하는 것도 가능
- 엘라스틱 서치를 분산환경으로 구성하는 경우, 하나의 인덱스가 여러 노드에 분산되어 저장되어 관리가 된다.
- 엘라스틱 서치는 인덱스 생성 시 기본적으로 5개의 프라이머리 샤드와 1개의 레플리카 샤드 세트를 생성한다.
- 인덱스 이름은 모두 소문자여야 하며 추가, 수정, 삭제, 검색은 RESTful API로 수행이 가능하다.
- `만약 인덱스가 없는 상태에서 데이터가 추가된다면 데이터를 이용해 인덱스가 자동으로 생성된다.`

> @샤드
- 색인된 문서는 하나의 인덱스에 담긴다. 인덱스 내부에 색인된 데이터는 물리적인 공간에 여러 개의 파티션으로 나뉘어 구성되는데, 이 파티션을 엘라스틱 서치에서는 샤드라 부른다.
- 엘라스틱 서치는 다수의 샤드로 문서를 분산 저장하고 있어 데이터 손실 위험을 최소화할 수 있다.

> @타입
- 타입(Type)은 인덱스의 논리적 구조를 의마하며, 인덱스 속성에 따라 분류하기도 한다.
- 6.1 버전 부터는 인덱스당 하나의 타입만을 사용할 수 있다.

> @문서
- 문서는 엘라스틱 서치에서 데이터가 저장되는 최소 단위이다.
- 기본적으로 JSON 포맷으로 데이터가 저장된다.
- 데이터베이스와 비교하자면 테이블의 행이 엘라스틱 서치의 문서에 해당한다고 볼 수 있다.
- 하나의 문서는 다수의 필드로 구성돼 있는데 각 필드는 데이터의 형태에 따라 용도에 맞는 데이터 타입(Data Type)을 정의해야 한다.
- 또한 문서는 중첩 구조를 지원하기 때문에 이를 이용해 문서 안에 문서를 지정하는 것도 가능하다.

> @필드
- 필드는 문서를 구성하기 위한 속성
- 일반적으로 데이터베이스의 컬럼과 비교할 수 있으나, 컬럼이 정적인 데이터 탕비인데 반해 필드는 좀 더 동적인 데이터 타입이라 할 수 있다.
- 하나의 필드는 목적에 따라 다수의 데이터 타입을 가질 수 있다.
  ex) 매칭 검색, 초성 검색을 지원할 수 있도록 2개의 데이터 타입을 정의하는 것이 가능

> @매핑
- 문서의 필드와 필드의 속성을 정의, 그에 따른 색인 방버븡 정의하는 프로세스
- 인덱스의 매핑 정보에는 여러 가지 데이터 타입을 지정할 수 있지만 필드명은 중복해서 사용할 수 없다.

### 노드의 종류
- @클러스터는 물리적인 노드 인스턴스들의 모임이라 할 수 있다.
- 클러스터는 모든 노드의 검색과 색인 작업을 관장하는 논리적인 개념이라 할 수 있다.
- 관계형 데이터베이스의 경우 모든 요청을 서버 하나에서 처리하여 결과를 제공하지만 엘라스틱 서치의 경우에는 다수의 서버로 분산해서 처리하는 것이 가능하여 대용량 데이터를 처리할 수 있다.
- 분산 처리를 위해서는 다양한 형태의 노드들을 조합하여 클러스터를 구성해야 한다.
- 기본적으로 마스터 노드가 전체적인 클러스터를 관리하고 데이터 노드가 실제 데이터를 관리한다.
- 4가지 유형의 노드

  |노드명|용도|
          |:---|:---|
  |마스터노드(Master Node)|- 클러스터를 관리 <br/>- 노드 추가와 제거 같은 클러스터의 전반적인 관리를 담당한다.|
  |데이터 노드(Data Node)|- 실질적인 데이터를 저장한다. <br/>- 검색과 통계 같은 데이터 관련 작업을 수행한다.|
  |코디네이팅 노드(Coordinating Node)|- 사용자의 요청만 받아서 처리 <br/>- 클러스터 관련 요청은 마스터 노드에 전달하고 데이터 관련 요청은 데이터 노드에 전달한다.|
  |인제스트 노드(Ingest Node)|- 문서의 전처리 작업을 담당한다. <br/> - 인덱스 생성 전 문서의 형식을 다양하게 변경할 수 있다.|

    - 설정에 따라 각 노드는 한 가지 유형으로 동작할 수도 있고 여러 개의 유형을 겸해서 동작할 수 있다.

> @마스터 노드(Master Node)
- 인덱스를 생성, 삭제하는 등 클러스터와 관련된 전반적인 작업을 담당한다.
- 위와 같은 역할을 수행하기 위해서 네트워크 속도가 빠르고 지연이 없는 노드를 마스터 노드로 선정해야 한다.
- 다수의 노드를 마스터 노드로 성정할 수 있지만 결과적으로 하나의 노드만이 마스터 노드로 선출되어 동작한다.
- 마스터 노드 전용으로 설정하는 방법
    - `conf/elasticsearch.yml`
    ```yaml
    node.master: true
    node.data: false
    node.ingest: false
    search.remote.connect: false
    ```
> @데이터 노드(Data Node)
- 데이터 노드는 문서가 실제로 저장되는 노드
- 데이터가 실제로 분산 저장되는 물리적 공간인 샤드가 배치되는 노드
- 색인 작업은 CPU, 메모리, 스토리지 같은 컴퓨팅 리소스를 많이 소모하기 때문에 리소스 모니터링을 필요로한다.
- 데이터 노드는 가능한 마스터 노드와 분리해서 구성하는 것이 좋다.
- 단 색인할 문서의 수가 적으면 함께 구성해도 상관은 없다.
- 데이터 노드로 성정하는 방법
    - `conf/elasticsearch.yml`
    ```yaml
    node.master: false
    node.data: true
    node.ingest: false
    search.remote.connect: false
    ```

> @코디네이팅 노드(Coordinating Node)
- 데이터 노드, 마스터 노드, 인제스트 노드의 역할을 하지 않고, 들어온 요청을 단순히 라운드로빈 방식으로 분산시켜 주는 노드이다.
- 코디네이팅 노드로 설정하는 방법
    - `conf/elasticsearch.yml`
    ```yaml
    node.master: false
    node.data: false
    node.ingest: false
    search.remote.connect: false
    ```

> @인제스트 노드(Ingest Node)
- 색인 전 데이터를 전처리 하기 위한 노드
- 데이터의 포맷을 변경하기 위해 스크립트로 전처리 파이프라인을 구성하고 실행할 수 있다.
    - `conf/elasticsearch.yml`
    ```yaml
    node.master: false
    node.data: false
    node.ingest: true
    search.remote.connect: false
    ```

### 클러스터, 노드, 샤드
- 클러스터와 노드의 관계 (하나의 클러스터에 노드1, 노드2로 구성되는 경우)
    - 엘라스틱 서치 클러스터는 인덱스의 문서를 조회할 때 마스터 노드를 통해 2개의 노드를 모두 조회하여 각 데이터를 취합한 후 결과를 하나로 합쳐 제공한다.
    - 현재는 하나의 클러스터로만 구성되어 있지만 여러 개의 클러스터를 연결하여 구성할 수도 있다.
        - 두 개 이상의 클러스터로 구성하는 경우 각 클러스터 명으로 구분되며 명시하지 않는 경우 임의 문자열로 지정된다.
    - `클러스터에 있는 노드는 실시간으로 추가, 제거가 가능하여 가용성, 확장성 측면에서 매우 유연하다.`

- 클러스터의 동작 방식 이해 (하나의 클러스터에 3개의 노드로 구성되는 경우)
    - 프라미머리 샤드와 레플리카 샤드의 수를 조정하며 인덱스 생성 시 클러스터가 어떻게 동작하는지 분석
    - 프라이머리 샤드 3개, 레플리카 샤드 0개를 세트로 구성하는 경우
        ```json
        {
          "settings": {
            "index": {
              "number_of_shards": 3,
              "number_of_replicas": 0
            }
          }
        }
        ```
        - 샤드는 분산된 데이터에 따라 순차적인 번호를 가진다.
        - 일반적으로 프라이머리 샤드느 안정성을 위해 하나의 노드에 하나씩 분산된다.
        - 인덱스에 다수의 문서를 색인하게 되면 문서는 3개의 샤드 골고루 분산 저장한다.

    - 프라이머리 샤드 6개, 레플리카 샤드 0개를 세트로 구성하는 경우
        ```json
        {
          "settings": {
            "index": {
              "number_of_shards": 6,
              "number_of_replicas": 0
            }
          }
        }
        ```
        - 3개의 노드에 프라이머리 샤드 6개가 노드당 2개가 배치되며, 색인 시 6개의 샤드에 데이터가 분산된다.

    - 프라이머리 샤드 3개, 레플리카 샤드 1개 세트 구성
        - 레플리카 샤드는 프라이머리 샤드의 복제본이다.
        ```json
        {
          "settings": {
            "index": {
              "number_of_shards": 3,
              "number_of_replicas": 1
            }
          }
        }
        ```
        - 엘라스틱 서치는 장애 시 레플리카 샤드를 이용해 샤드를 복구한다.
        - 프라이머리 샤드와 레플리카 샤드가 서로 다른 노드에 배치된다.

    - 프라이머리 샤드 3개, 레플리카 샤드 3개 세트 구성
        - 레플리카 샤드는 프라이머리 샤드의 복제본이다.
        ```json
        {
          "settings": {
            "index": {
              "number_of_shards": 3,
              "number_of_replicas": 3
            }
          }
        }
        ```
        - 프라이머리 샤드의 복제본이 존재하기 때문에 물리적인 노드 하나가 죽더라도 나머지 노드 2개가 전체 데이터를 복구할 수 있다.
        - 장애가 발생하면 마스터 노트드는 데이터를 재분배하거나 레플리카 샤드를 프라이이머리 샤드로 승격시켜 서비스 중단 없는 복구가 가능해진다.
    - `장애극복(Failover) 상황을 염두에 두고 노드와 샤드의 수를 적절하게 구성해야 한다.`
